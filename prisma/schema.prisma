generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  CASHIER
  REPAIR_STAFF
}

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
}

enum StoreStatus {
  ACTIVE
  PAUSED
}

enum UserSystem {
  OPERATION
  ACCOUNTING
  BOTH
}

enum RepairStatus {
  PENDING
  PROCESSING
  REPAIR_COMPLETED
  DELIVERED
}

enum RepairIntakeType {
  WALK_IN
  COURIER
}

enum SmsStatus {
  PENDING
  SENT
  FAILED
}

model User {
  id           String   @id @default(cuid())
  username     String   @unique
  displayName  String
  passwordHash String
  role         UserRole
  system       UserSystem @default(OPERATION)
  profileImageId Int    @default(1)
  accessDashboard Boolean @default(false)
  accessRepairs  Boolean @default(false)
  accessClients  Boolean @default(false)
  accessBrands   Boolean @default(false)
  accessUsers    Boolean @default(false)
  accessSms      Boolean @default(false)
  accessSettings Boolean @default(false)
  storeId     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  sessions     Session[]
  store        Store?   @relation(fields: [storeId], references: [id], onDelete: SetNull)
  repairsCreated Repair[]
  repairAudits  RepairAudit[]

  @@index([system])
  @@index([storeId])
}

model Session {
  id         String   @id @default(cuid())
  tokenHash  String   @unique
  userId     String
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Brand {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  repairs   Repair[]
}

model Client {
  id        String      @id @default(cuid())
  name      String
  mobile    String      @unique
  tier      LoyaltyTier @default(BRONZE)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  repairs   Repair[]

  @@index([name])
}

model Store {
  id        String      @id @default(cuid())
  name      String
  code      String      @unique
  city      String
  status    StoreStatus @default(ACTIVE)
  notes     String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  users     User[]
  repairs   Repair[]

  @@index([name])
  @@index([city])
  @@index([status])
}

model Repair {
  id        String       @id @default(cuid())
  billNo    String       @unique
  physicalBillNo String?
  clientId  String
  brandId   String
  intakeType RepairIntakeType
  repairTypeId String?
  storeId   String
  totalAmount Int
  advanceAmount Int
  estimatedDeliveryDate DateTime
  status    RepairStatus @default(PENDING)
  isPostponed Boolean    @default(false)
  description String?
  trackingTokenHash String
  createdById String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client   Client @relation(fields: [clientId], references: [id], onDelete: Restrict)
  brand    Brand  @relation(fields: [brandId], references: [id], onDelete: Restrict)
  repairType RepairType? @relation(fields: [repairTypeId], references: [id], onDelete: SetNull)
  store    Store  @relation(fields: [storeId], references: [id], onDelete: Restrict)
  createdBy User  @relation(fields: [createdById], references: [id], onDelete: Restrict)
  smsOutbox SmsOutbox[]
  audits    RepairAudit[]
  items     RepairItem[]

  @@index([storeId])
  @@index([status])
  @@index([estimatedDeliveryDate])
  @@index([repairTypeId])
}

model RepairItem {
  id           String   @id @default(cuid())
  repairId     String
  repairTypeId String
  price        Int
  createdAt    DateTime @default(now())

  repair     Repair     @relation(fields: [repairId], references: [id], onDelete: Cascade)
  repairType RepairType @relation(fields: [repairTypeId], references: [id], onDelete: Restrict)

  @@index([repairId])
  @@index([repairTypeId])
}

model RepairType {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  repairs   Repair[]
  items     RepairItem[]

  @@index([name])
  @@index([isActive])
}

model RepairBillSequence {
  id         Int      @id @default(1)
  nextNumber Int      @default(1)
  updatedAt  DateTime @updatedAt
}

model SmsOutbox {
  id        String    @id @default(cuid())
  repairId  String
  recipient String
  message   String
  type      String
  status    SmsStatus @default(PENDING)
  scheduledFor DateTime?
  sentAt    DateTime?
  providerResponse String?
  createdAt DateTime @default(now())

  repair    Repair @relation(fields: [repairId], references: [id], onDelete: Cascade)

  @@index([repairId])
  @@index([status])
}

model RepairAudit {
  id        String   @id @default(cuid())
  repairId  String
  eventType String
  oldValue  String?
  newValue  String?
  performedById String
  createdAt DateTime @default(now())

  repair    Repair @relation(fields: [repairId], references: [id], onDelete: Cascade)
  performedBy User @relation(fields: [performedById], references: [id], onDelete: Restrict)

  @@index([repairId])
  @@index([eventType])
}
